Procedure dur_wwait window nowait "DRG assignment performed, calculating duration SD's"on error do sel_dstrselect drgdistron errorgoto toplc_tcas=n_caslc_tmean=dur_meanif dur_mean=0	wait window nowait 'All durations are zero, duration based weights cannot be calculated'	select drgdistr	do grpohje	returnendifreplace all dur_mean with dur_mean/n_cas for n_cas>0replace all weight with dur_mean/lc_tmean for n_cas>0select analgoto toplc_sd=0lc_re2=0lc_dsd=0lc_dre2=0do while not eof()  select drgdistr  seek anal.drg  replace anal.dur_w with drgdistr.weight  replace drgdistr.sd with drgdistr.sd+abs(anal.dur-drgdistr.dur_mean)  replace drgdistr.re2 with drgdistr.re2+((anal.dur-drgdistr.dur_mean)**2)  lc_dsd=lc_dsd+abs(anal.dur-drgdistr.dur_mean)  lc_dre2=lc_dre2+((anal.dur-drgdistr.dur_mean)**2)  select anal  skipenddoselect drgdistrreplace all drgdistr.sd with drgdistr.sd/(drgdistr.n_cas-1) for n_cas>1replace all drgdistr.re2 with drgdistr.re2/(drgdistr.n_cas-1)for n_cas>1goto topreplace sd with lc_dsd/(lc_ncas-1)replace re2 with lc_dre2/lc_ncaswait window nowait 'First trimming'select anallc_ncas=0lc_dur=0lc_re2=0goto topdo while not eof()  select drgdistr  seek anal.drg  if anal.dur>drgdistr.dur_mean+3*drgdistr.sd or anal.dur<drgdistr.dur_mean-3*drgdistr.sd    replace anal.trimmed with .t.  else    replace anal.trimmed with .f.    lc_ncas=lc_ncas+1    lc_dur=lc_dur+anal.dur    replace drgdistr.n1trim with drgdistr.n1trim+1    replace drgdistr.m1trim with drgdistr.m1trim+anal.dur  endif  select anal  skipenddoselect drgdistrlc_tmean=lc_dur/lc_ncasreplace all m1trim with m1trim/n1trim for n1trim>0replace all w1trim with m1trim/lc_tmean for n1trim>0goto topreplace m1trim with lc_tmeanreplace n1trim with lc_ncaswait window nowait "Calculating SD's after first trimming"select anallc_sd=0lc_re2=0goto topdo while not eof()  select drgdistr  seek anal.drg  replace drgdistr.sd1trim with drgdistr.sd1trim+(abs(anal.dur -drgdistr.m1trim)/1000)  replace drgdistr.re2_1tri with drgdistr.re2_1tri+(((anal.dur-drgdistr.m1trim)**2)/1000)  lc_sd=lc_sd+(abs(anal.dur - drgdistr.m1trim)/1000)  lc_re2=lc_re2+(((anal.dur - drgdistr.m1trim)**2)/1000)  select anal  skipenddoselect drgdistrreplace all drgdistr.sd1trim with 1000*drgdistr.sd1trim/(n1trim) for n1trim>1replace all drgdistr.re2_1tri with 1000*drgdistr.re2_1tri/drgdistr.n1trim for n1trim>0goto topreplace sd1trim with 1000*lc_sd/(lc_ncas-1)replace re2_1tri with 1000*lc_re2/lc_ncaswait window nowait 'Second trimming'select anallc_ncas=0lc_dur=0lc_re2=0goto topdo while not eof()  select drgdistr  seek anal.drg  if anal.dur>drgdistr.m1trim+1.96*drgdistr.sd1trim or anal.dur<drgdistr.m1trim-1.96*drgdistr.sd1trim     replace anal.trimmed with .t.  else    lc_ncas=lc_ncas+1    lc_dur=lc_exp+anal.dur    replace drgdistr.ntcas with drgdistr.ntcas+1    replace drgdistr.m2trim with drgdistr.m2trim+anal.dur  endif  select anal  skipenddoselect drgdistrlc_dur=lc_dur/lc_ncasreplace all m2trim with m2trim/n2trim for n2trim>0replace all w2trim with m2trim/lc_dur for n2trim>0goto topreplace m2trim with lc_durreplace n2trim with lc_ncaswait window nowait "Calculating SD's after second trimming"select anallc_sd=0lc_re2=0goto topdo while not eof()  select drgdistr  seek anal.drg  replace anal.exp_tw with drgdistr.w2trim  replace drgdistr.sd2trim with drgdistr.sd2trim+(abs(anal.dur-drgdistr.m2trim)/1000)  replace drgdistr.re2_2tri with drgdistr.re2_2tri+(((anal.dur-drgdistr.m2trim)**2)/1000)  lc_sd=lc_sd+(abs(anal.dur - drgdistr.m2trim)/1000)  lc_re2=lc_re2+(((anal.dur - drgdistr.m2trim)**2)/1000)  select anal  skipenddoselect drgdistrreplace all drgdistr.sd2trim with 1000*drgdistr.sd2trim/(n2trim-1) for ntcas>1replace all drgdistr.re2_2tri with 1000*drgdistr.re2_2tri/drgdistr.n2tri for drgdistr.n2trim>0goto topreplace exptsd with 1000*lc_sd/(lc_ncas-1)replace exptre2 with 1000*lc_re2/lc_ncasactivate window analbrowse in window anal save nowaitselect drgdistrdo grpohjereturnprocedure sel_dstrselect 0use (ds_datasel+'_out.dbf') alias drgdistrset order to drgreturn